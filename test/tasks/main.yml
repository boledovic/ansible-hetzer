---
#check rescue mode
    - name: check rescue mode
      shell: grep "Hetzner Rescue System" /etc/motd
      register: rescue_mode
      failed_when: false

#display msg if false
    - name: ensure rescue mode
      fail:
        msg: System not in RESCUE mode
      when: rescue_mode.rc != 0

#generate cfg file for installimage
    - name: generate installimage.conf
      template: >
        src={{ item }}.j2
        dest=/{{ item }}
        mode=0600
        force=yes
      with_items:
        - "installimage.conf"

#install system through installimage
    - name: install system
      shell: /root/.oldroot/nfs/install/installimage -a -c /installimage.conf

#creating boot partitions to later use in RAID1
    - name: create boot partition 
      parted:
        device: "{{ item }}"
        number: 1
        state: present
        part_end: 1GiB
      with_items: 
        -  /dev/sdd

#creating SWAP partitions to later use in RAID0
    - name: create SWAP partition 
      parted:
        device: "{{ item }}"
        number: 2
        state: present
        part_start: 1GiB
        part_end: 33GiB
      with_items: 
        -  /dev/sdd

#creating LVM partitions to later use in RAID1
    - name: create LVM partition 
      parted:
        device: "{{ item }}"
        number: 3
        flags: [ lvm ]
        state: present
        part_start: 33GiB
        part_end: 333GiB
      with_items: 
        -  /dev/sdd

#creating RAID1 array
    - name: create /dev/md0 RAID1 array from boot partitions
      shell: "yes | mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sdc1 /dev/sdd1 --metadata=0.90"

#creating RAID0 array
#    - name: create /dev/md1 RAID0 array from SWAP partitions
#      shell: "yes | mdadm --create /dev/md1 --level=0 --raid-devices=2 /dev/sdc2 /dev/sdd2"

#creating RAID1 array
    - name: create /dev/md2 RAID1 array from LVM partitions
      shell: "yes | mdadm --create /dev/md2 --level=1 --raid-devices=2 /dev/sdc3 /dev/sdd3" #--metadata=0.90"

#    - name: reboot system
#      reboot:
#        reboot_timeout: 300

#    - name: update packages
#      raw: apt-get update

#    - name: install python
#      raw: apt-get -y install python


